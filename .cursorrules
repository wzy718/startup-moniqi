# Cursor AI 开发规则

## 项目概述
- **项目类型**：微信小游戏（使用 Cocos Creator 3.8.8 开发）
- **游戏类型**：文字模拟经营游戏
- **对标游戏**：《纸上谈亲》、《摆摊模拟器》
- **开发语言**：TypeScript

## 沟通与文档
- **所有代码注释和文档必须使用中文**
- **所有变量名、函数名、类名使用英文，但注释必须用中文说明**
- **与用户沟通时使用中文**
- **每次编辑文件前，用中文简要说明更改的原因和目的**

## 代码风格规范

### TypeScript/Cocos Creator 规范
- 使用 TypeScript 严格模式
- 遵循 Cocos Creator 3.x 的组件化开发模式
- 组件命名使用 PascalCase（如：`ShopManager.ts`）
- 变量和函数命名使用 camelCase（如：`calculateProfit()`）
- 常量使用 UPPER_SNAKE_CASE（如：`WEEKS_PER_MONTH`）
- 使用两个空格缩进
- 文件编码使用 UTF-8

### 数值系统规范
- **时间单位**：1回合 = 1周
- **金额单位**：元，使用整数存储（最终结算时取整）
- **概率/倍率**：使用 0~1 的小数或倍率（例如 `1.1` 表示 +10%）
- **月成本折算**：统一使用 `WEEKS_PER_MONTH = 4`（游戏口径）
- **命名空间**：避免字段冲突，使用命名空间区分（如：`player.cash`、`shop.monthly_rent`）

### 回合结算顺序（必须遵守）
1. 回合开始：读取存档值
2. 生成事件候选：从 `docs/数值/events.csv` 过滤并抽取
3. 玩家选择与检定：根据 `docs/数值/choices.csv` 应用 `success_rate`
4. 经营结算：计算每家店的收入、成本、利润
5. 玩家结算：汇总利润，扣除生活费、债务利息等
6. 状态结算：更新压力、健康、精力等
7. 时间推进：`current_week += 1`
8. 死亡/破产判定

## 文件组织规范

### 目录结构
- `cocos/` - Cocos Creator 项目文件
- `docs/` - 项目文档
  - `docs/数值类型.md` - 数值系统核心文档（必须参考）
  - `docs/数值/字段字典.md` - 数据表字段说明
  - `docs/数值/*.csv` - 游戏数据表（事件、选择、成就等）
  - `docs/prd/理念.md` - 游戏设计理念

### 代码文件组织
- 组件按功能模块组织
- 数值计算逻辑统一管理
- 数据表读取使用统一的 CSV 解析器
- 存档系统使用结构化的数据格式

## 开发注意事项

### 数值系统
- **存档值（state）**：需要持久化的状态（如 `cash`、`stress`、员工列表）
- **派生值（derived）**：由存档值计算得出，不建议落库（如 `weekly_profit`、`total_asset`）
- 所有数值计算必须参考 `docs/数值类型.md`
- CSV 数据表字段含义参考 `docs/数值/字段字典.md`

### 游戏机制
- 每回合相当于一周时间
- 事件抽取基于当前状态和已发生事件
- 支持多种游戏结束条件：破产、压力过大、年龄、疾病
- 支持继承机制（孩子继承店铺）

### 性能优化
- 避免在每帧更新中进行复杂计算
- 使用对象池管理频繁创建/销毁的对象
- 合理使用缓存减少重复计算
- 大列表使用虚拟滚动

### 错误处理
- 所有异步操作必须处理错误
- 数据加载失败要有友好的提示
- 存档损坏要有恢复机制
- 关键操作要有确认提示

## Git 工作流
- **不要每次都提交 git**（除非用户明确要求）
- 提交信息使用中文，要清晰描述变更内容
- 遵循有意义的提交信息格式

## 测试要求
- 关键数值计算要有单元测试
- 回合结算逻辑要测试边界情况
- 存档/读档功能要测试各种异常情况
- 事件抽取逻辑要测试随机性和权重

## 特殊要求
- 开发环境在 Windows 11，使用 Windows 系统命令语法
- 在 PowerShell 中需要分开执行命令
- 所有用户可见的文本必须支持中文显示
- 数值显示要格式化（如金额显示千分位）

## AI 助手行为规范
- 理解游戏设计文档后再编写代码
- 修改数值相关代码前，必须参考 `docs/数值/数值类型.md`
- 创建新功能前，先确认是否符合游戏设计理念
- 提供代码时，要包含必要的中文注释
- 遇到不确定的地方，主动询问用户或查阅文档
