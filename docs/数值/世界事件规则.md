# 世界事件规则（对齐 `docs/数值/world_events.csv`）

> 目标：让世界事件从“文案+字符串”变成可实现、可调参、可叠加的系统。

---

## 1. 触发与持续

- 触发方式：每月结算开始时，对“当前未激活”的世界事件逐个做一次概率检定 `random() < probability`。
- `duration_min/duration_max`：
  - `>= 1`：随机一个整数月数作为持续时间
  - `-1`：永久（直到游戏结束或你设计解除事件）
- `trigger_condition`：只支持一个**安全子集**（避免写成任意脚本）：
  - `none`
  - `week>NUM`、`week>=NUM`、`week<NUM`、`week<=NUM`（字段名保留，语义为“月”）
  - `cash>NUM`（玩家现金条件）
  - `rating>NUM`（主店或当前店评分条件，具体实现需定口径）
  - `location=ID`（门面 `location_id` 条件）

---

## 2. 作用范围（scope）

`scope` 决定一个世界事件影响哪些店铺：

- `global`：影响所有店铺
- `regional`：影响“所在区域”的店铺（需要你在门面/城市系统里定义 region_id；若暂无则可先当 global）
- `category`：影响特定品类（需要你在事件定义里加一个 `target_shop_type` 或用 `world_flags_add` + 代码映射）
- `location`：影响特定 `location_id`（由 `trigger_condition` 或字段扩展决定）

---

## 3. 结构化字段的解释（强烈建议按此实现）

### 3.1 客流/客单

- `dine_in_traffic_mult`：堂食客流倍率（默认 `1.0`）
- `delivery_traffic_mult`：外卖订单倍率（默认 `1.0`）
- `avg_ticket_mult`：客单价倍率（默认 `1.0`）

推荐落地方式（月结算时）：

- `daily_customers *= dine_in_traffic_mult`
- `weekly_orders *= delivery_traffic_mult`（字段名保留，语义为“月订单量”）
- `avg_ticket *= avg_ticket_mult`（或只作用在结算的派生值上，不回写存档）

### 3.2 成本

- `labor_cost_mult`：人工成本倍率（默认 `1.0`），作用在 `shop.monthly_labor_cost`
- `cogs_cost_mult`：原料/损耗倍率（默认 `1.0`），作用在 `shop_weekly_cogs`（字段名保留，语义为“月”）
- `weekly_fixed_cost_add`：每月固定额外成本（元）（字段名保留）
- `one_time_cost_add`：一次性成本（元），在事件触发当月扣除（或均摊到持续期也可，但要写死规则）

### 3.3 特殊/标记

- `forced_close_chance`：强制关店概率（如触发，则当月堂食/外卖归零，或直接跳过经营结算）
- `shop_damage_chance`：店铺受损概率（如触发，则加一次性修理费或降低评分）
- `rating_delta`：评分加成（建议 clamp 到 `[1.0, 5.0]`）
- `competition_index_delta`：竞争指数变化（影响后续事件/客流）
- `category_trust_delta`：品类信任变化（影响对应品类所有店的客流/转化）
- `world_flags_add`：`|` 分隔的标记（例如 `chaos_mode`），用于解锁特殊逻辑/彩蛋（尽量少用）

---

## 4. 叠加规则（必须写死）

如果同一月多个世界事件同时影响同一店铺，建议：

- 倍率字段：相乘叠加（例如 `0.7 × 0.8`）
- `*_add` 字段：相加
- 概率字段：独立检定（各自触发一次）
- 最终 clamp：
  - 客流倍率最小值建议 `0.0`，最大值建议 `3.0`
  - `avg_ticket` 最小值建议 `1`

---

## 5. 旧字段（legacy）处理

`traffic_modifier/cost_modifier/special_effect` 保留用于回溯旧内容。建议实现：

- 若结构化字段不为空：直接用结构化字段
- 否则：再尝试解析 legacy 字段（仅兼容旧行，不鼓励新增继续使用）
