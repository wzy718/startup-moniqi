<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¼€åº—æ¨¡æ‹Ÿå™¨ Demo v2ï½œæç®€ä¸»é¢æ¿ + å…¨å…¥å£é¡µé¢</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2b;
      --text:#e8eefc;
      --muted:#9bb0d9;
      --line:rgba(255,255,255,.10);
      --good:#35d07f;
      --bad:#ff5f6a;
      --warn:#ffb020;
      --accent:#7c5cff;
      --shadow:0 12px 40px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(1000px 700px at 80% 30%, rgba(53,208,127,.18), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(255,176,32,.14), transparent 55%),
        var(--bg);
    }
    .app{max-width:460px; margin:0 auto; padding:16px 14px 92px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 2px 12px;}
    .left{display:flex; align-items:center; gap:10px; min-width:0;}
    .avatar{width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, rgba(124,92,255,.9), rgba(53,208,127,.8)); box-shadow:0 10px 30px rgba(124,92,255,.22);}
    .title{min-width:0}
    .title b{display:block; font-size:14px; font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .title span{display:block; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      border-radius:999px; background:rgba(18,26,43,.55);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      cursor:pointer; user-select:none;
      font-size:12px;
    }
    .icon{
      width:34px; height:34px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(18,26,43,.55);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
    }
    .icon:active{transform:scale(.98)}
    .card{
      background:linear-gradient(180deg, rgba(18,26,43,.85), rgba(15,23,40,.75));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sec{margin:12px 0}
    .head{padding:14px 14px 10px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px;}
    .head h2{margin:0; font-size:14px}
    .head .hint{font-size:12px; color:var(--muted)}
    .pad{padding:0 14px 14px}
    .mono{font-family:var(--mono)}
    .row{display:flex; justify-content:space-between; gap:10px; align-items:center; padding:10px 10px; border-radius:var(--r2); border:1px solid var(--line); background:rgba(11,15,25,.25)}
    .row b{font-size:13px; font-weight:950}
    .row span{font-size:12px; color:var(--muted)}
    .btn{
      width:100%;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(53,208,127,.85));
      color:#0b0f19;
      font-weight:950;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 18px 40px rgba(124,92,255,.25);
      user-select:none;
    }
    .btn.secondary{
      background:rgba(18,26,43,.65);
      border:1px solid var(--line);
      color:var(--text);
      box-shadow:none;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    /* æç®€æ ¸å¿ƒé¢æ¿ */
    .hero{padding:14px}
    .cash{font-size:22px; font-weight:1000; letter-spacing:.3px}
    .subline{margin-top:6px; font-size:12px; color:var(--muted)}
    .chips{margin-top:12px; display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(11,15,25,.20);
      padding:8px 10px;
      display:flex; gap:8px; align-items:center;
      font-size:12px;
      cursor:pointer; user-select:none;
    }
    .chip b{font-weight:950}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}

    /* å¿«æ·å…¥å£ */
    .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:14px;}
    .nav{
      position:relative;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(11,15,25,.22);
      padding:10px 8px;
      cursor:pointer;
      user-select:none;
      min-height:72px;
    }
    .nav:hover{background:rgba(11,15,25,.32)}
    .nav .e{font-size:20px}
    .nav .n{margin-top:6px; font-size:12px; font-weight:950}
    .nav .t{margin-top:3px; font-size:11px; color:var(--muted)}
    .dot{position:absolute; top:8px; right:8px; width:9px; height:9px; border-radius:999px; background:var(--bad); box-shadow:0 0 0 4px rgba(255,95,106,.18)}

    /* äº‹ä»¶é¡µ */
    .choice{cursor:pointer; user-select:none}
    .choice:hover{background:rgba(11,15,25,.32)}
    .fx{margin-top:6px; display:flex; gap:6px; flex-wrap:wrap}
    .fx i{font-style:normal; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(15,23,40,.55)}
    .fx .g{border-color:rgba(53,208,127,.35); background:rgba(53,208,127,.10)}
    .fx .b{border-color:rgba(255,95,106,.35); background:rgba(255,95,106,.10)}
    .fx .w{border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.10)}

    /* åº•éƒ¨å›ºå®šæ ï¼ˆä»… Homeï¼‰ */
    .footer{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 14px 14px;
      background:linear-gradient(180deg, transparent, rgba(11,15,25,.78) 18%, rgba(11,15,25,.96));
      display:flex; justify-content:center;
      z-index:30;
    }
    .footer .wrap{width:min(460px, 100%); display:flex; gap:10px;}
    .pillbtn{
      flex:1;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(18,26,43,.55);
      color:var(--text);
      padding:12px 12px;
      font-weight:950;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .pillbtn.primary{background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(53,208,127,.85)); color:#0b0f19; border:none}

    /* æŠ½å±‰ */
    .mask{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:flex-end; justify-content:center; padding:16px; z-index:50;}
    .sheet{width:min(460px, 100%); border-radius:22px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(18,26,43,.98), rgba(15,23,40,.96)); box-shadow:0 20px 70px rgba(0,0,0,.6); overflow:hidden;}
    .sheet .sh{display:flex; align-items:center; justify-content:space-between; padding:14px 14px; border-bottom:1px solid var(--line)}
    .sheet .sh b{font-size:14px}
    .sheet .body{padding:12px 14px 14px; display:flex; flex-direction:column; gap:10px}
    .close{width:36px;height:36px;border-radius:14px;border:1px solid var(--line); background:rgba(11,15,25,.35); color:var(--text); cursor:pointer}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:92px; transform:translateX(-50%);
      background:rgba(18,26,43,.92); border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:14px; box-shadow:0 16px 50px rgba(0,0,0,.55);
      font-size:12px; color:rgba(232,238,252,.95);
      z-index:9999; opacity:0; transition:opacity .18s ease; pointer-events:none;
    }
    .toast.on{opacity:1}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="app" id="app"></div>

  <div class="footer" id="footer">
    <div class="wrap">
      <div class="pillbtn" id="btnTimeline">ğŸ—“ï¸ æ—¶é—´çº¿</div>
      <div class="pillbtn primary" id="btnStart">â–¶ å¼€å§‹æœ¬å‘¨</div>
    </div>
  </div>

  <!-- Sheets -->
  <div class="mask" id="sheetMask" aria-hidden="true">
    <div class="sheet">
      <div class="sh">
        <b id="sheetTitle">Sheet</b>
        <button class="close" id="sheetClose">âœ•</button>
      </div>
      <div class="body" id="sheetBody"></div>
    </div>
  </div>

  <script>
    // ===== Utils =====
    const $ = (sel)=>document.querySelector(sel);
    const app = $("#app");
    const toastEl = $("#toast");
    const fmtMoney = (n)=> {
      const sign = n < 0 ? "-" : "";
      const x = Math.abs(Math.round(n));
      return sign + "Â¥ " + x.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");
    };
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const seasonOfWeek = (week)=> {
      const w = ((week-1)%52)+1;
      if (w<=13) return {name:"æ˜¥", icon:"ğŸŒ±"};
      if (w<=26) return {name:"å¤", icon:"â˜€ï¸"};
      if (w<=39) return {name:"ç§‹", icon:"ğŸ‚"};
      return {name:"å†¬", icon:"â„ï¸"};
    };
    const toast = (msg)=>{
      toastEl.textContent=msg;
      toastEl.classList.add('on');
      clearTimeout(toast._t);
      toast._t=setTimeout(()=>toastEl.classList.remove('on'), 1200);
    };

    // ===== State (demo) =====
    const state = {
      playerName:"é˜¿åº—è€æ¿",
      title:"ç¨³å¥ç»è¥è€…",
      week: 37,
      year: 1,
      cash: 128400,
      assets: 312000,
      stress: 92,
      health: 71,
      age: 26,
      rep: 58,
      stressMaxWeeks: 2,
      livingCost: 2000,
      loanPay: 2680,
      world: {
        active:true,
        title:"ç–«æƒ…çˆ†å‘",
        remaining:6,
        meta:"å ‚é£Ÿå—é™ Â· å¤–å–çˆ†å‘ Â· é˜²ç–«å›ºå®šæˆæœ¬ä¸Šå‡",
        tags:[{t:"å ‚é£Ÿ -40%",k:"bad"},{t:"å¤–å– +30%",k:"good"}],
        dineInMul:0.6, deliveryMul:1.3,
      },
      shops: [
        {id:"s1", name:"é˜¿åº—å¥¶èŒ¶ Â· å†™å­—æ¥¼åº—", rating:4.3, baseProfit:8200, dineIn:0.40, delivery:0.60},
        {id:"s2", name:"é˜¿åº—å°åƒ Â· ç¤¾åŒºåº—", rating:4.0, baseProfit:-1300, dineIn:0.70, delivery:0.30},
        {id:"s3", name:"é˜¿åº—å’–å•¡ Â· å•†åœºåº—", rating:4.6, baseProfit:2900, dineIn:0.55, delivery:0.45},
      ],
      employees: [
        {id:"p1", name:"å°å‘¨", role:"åº—é•¿", mood:"ç´§ç»·", wage:5200, risk:"æƒ³è¯·å‡"},
        {id:"p2", name:"é˜¿èŠ±", role:"æ”¶é“¶", mood:"ä¸€èˆ¬", wage:3800, risk:"â€”"},
        {id:"p3", name:"å¤§å‹‡", role:"åå¨", mood:"ä¸é”™", wage:4200, risk:"â€”"},
      ],
      delivery: { enabled:true, budget: 300, feeRate: 0.18, orders: 420 },
      locations: [
        {id:"l1", name:"åœ°é“å£ 12ã¡", rent: 6800, foot: "é«˜", competition:"ä¸­"},
        {id:"l2", name:"ç¤¾åŒºé—¨å£ 18ã¡", rent: 5200, foot: "ä¸­", competition:"ä½"},
        {id:"l3", name:"å•†åœºäºŒå±‚ 22ã¡", rent: 9200, foot: "é«˜", competition:"é«˜"},
      ],
      achievements: [
        {id:"a1", name:"ç¬¬ä¸€æ¡¶é‡‘", desc:"ç°é‡‘è¾¾åˆ° Â¥100,000", prog: 1.0, claim:true},
        {id:"a2", name:"è¿é”èµ·æ­¥", desc:"æ‹¥æœ‰ 3 å®¶åº—é“º", prog: 1.0, claim:false},
        {id:"a3", name:"å£ç¢‘è¾¾äºº", desc:"ä»»ä¸€åº—è¯„åˆ† â‰¥ 4.8", prog: 0.65, claim:false},
      ],
      leaderboard: [
        {rank:1, name:"éš”å£ç‹æ€»", cash: 980000},
        {rank:2, name:"å¥¶èŒ¶æ•™çˆ¶", cash: 760000},
        {rank:3, name:"åŠ ç­æˆ˜ç¥", cash: 540000},
        {rank:18, name:"é˜¿åº—è€æ¿ï¼ˆä½ ï¼‰", cash: 128400},
      ],
      welfare: { dailyClaimed:false, skipTickets:2 },
      timeline: []
    };

    for(let i=0;i<7;i++){
      state.timeline.unshift({
        week: state.week - (7-i),
        title: ["å¼€ä¸šç¬¬ä¸€å¤©","æ‹›åˆ°å…³é”®åº—é•¿","ä¸€åœºæš´é›¨","å¹³å°æŠ½æˆä¸Šè°ƒ","é—¨é¢ç»­çº¦æˆåŠŸ","åŒåº—ç«äº‰å‡ºç°","ä¸Šå‘¨ï¼šå»¶é•¿è¥ä¸šæ—¶é—´"][i],
        net: [3200, 2100, 1800, 1200, 900, 5400, 6820][i]
      });
    }

    const eventsPool = [
      { id:"e_overtime", title:"å»¶é•¿è¥ä¸šæ—¶é—´",
        body:"å®¢æµä¸é”™ï¼Œä½†å‘˜å·¥å·²ç»å¾ˆç´¯äº†ã€‚ä½ è¦ä¸è¦æŠŠè¥ä¸šæ—¶é—´å†æ‹‰é•¿ 1 å°æ—¶ï¼Ÿ",
        choices:[
          { id:"A", title:"å»¶é•¿ 1 å°æ—¶ï¼Œå†²ä¸€æ³¢", desc:"åˆ©æ¶¦æ›´é«˜ï¼Œä½†å‹åŠ›ä¸Šå‡ã€‚",
            effects:{ cashEvent: 1200, stress:+6, health:-1, rep:+0 } },
          { id:"B", title:"ç»´æŒç°çŠ¶ï¼Œç¨³ä½", desc:"å°‘èµšä¸€ç‚¹ï¼Œä½†å‹åŠ›æ›´ç¨³ã€‚",
            effects:{ cashEvent: 0, stress:-2, health:+0, rep:+1 } },
          { id:"C", title:"ç¼©çŸ­ 1 å°æ—¶ï¼Œç»™å›¢é˜Ÿå–˜å£æ°”", desc:"åˆ©æ¶¦ä¸‹é™ï¼Œä½†å‹åŠ›å¤§å¹…ç¼“è§£ã€‚",
            effects:{ cashEvent: -800, stress:-8, health:+2, rep:+2 } }
        ]
      },
      { id:"e_supplier", title:"åŸæ–™æ¶¨ä»·é€šçŸ¥",
        body:"ä¾›åº”å•†é€šçŸ¥ï¼šæœ¬å‘¨èµ·åŸæ–™ä¸Šæ¶¨ 12%ã€‚ä½ è¦æ€ä¹ˆåº”å¯¹ï¼Ÿ",
        choices:[
          { id:"A", title:"ç«‹åˆ»æ¶¨ä»· 1 å…ƒ", desc:"æ¯›åˆ©ç¨³ï¼Œä½†å¯èƒ½æ‰å£ç¢‘ã€‚",
            effects:{ cashEvent: 600, stress:+2, health:+0, rep:-2 } },
          { id:"B", title:"è°ˆåˆ¤ + æ¢ä¾›åº”é“¾", desc:"æœ‰æœºä¼šå‹æˆæœ¬ï¼Œä½†è´¹ç²¾åŠ›ã€‚",
            effects:{ cashEvent: 900, stress:+4, health:-1, rep:+1 } },
          { id:"C", title:"å…ˆä¸æ¶¨ä»·ï¼Œåšä¿ƒé”€å¼•æµ", desc:"ç°é‡‘æ‰¿å‹ï¼Œä½†å£°æœ›ä¸Šæ¶¨ã€‚",
            effects:{ cashEvent: -500, stress:+1, health:+0, rep:+3 } }
        ]
      }
    ];

    // ===== Router =====
    const router = { view:"home", params:{} };
    const setView = (view, params={})=>{
      router.view=view; router.params=params;
      render();
      window.scrollTo({top:0, behavior:"instant"});
    };

    // ===== Sheets =====
    const sheetMask = $("#sheetMask");
    const sheetTitle = $("#sheetTitle");
    const sheetBody = $("#sheetBody");
    const openSheet = (title, bodyHtml)=>{
      sheetTitle.textContent = title;
      sheetBody.innerHTML = bodyHtml;
      sheetMask.style.display='flex';
      sheetMask.setAttribute('aria-hidden','false');
    };
    const closeSheet = ()=>{
      sheetMask.style.display='none';
      sheetMask.setAttribute('aria-hidden','true');
    };
    $("#sheetClose").addEventListener('click', closeSheet);
    sheetMask.addEventListener('click', (e)=>{ if(e.target===sheetMask) closeSheet(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSheet(); });

    // ===== Home: æç®€æ ¸å¿ƒé¢æ¿ï¼ˆåªæ˜¾ç¤ºï¼šç°é‡‘ / æœ¬å‘¨å‡€ç°é‡‘æµ / å‹åŠ› / å¥åº·ï¼‰=====
    function renderHome(){
      const s = state;
      const season = seasonOfWeek(s.week);

      const net = s._lastNet ?? 6820;
      const netClass = net>=0 ? "good" : "bad";

      const alert = (s.cash<=0) ? {t:"ç°é‡‘å‘Šæ€¥", d:"å»ºè®®è§¦å‘ Game Over / å¤æ´»å…¥å£ï¼ˆDemo æœªå®ç°ï¼‰"} :
                   (s.stress>=90) ? {t:`å‹åŠ›å±é™©ï¼ˆ${s.stressMaxWeeks}/4ï¼‰`, d:"æœ¬å‘¨å°½é‡é€‰å‡å‹/ç¨³ç°é‡‘æµ"} :
                   (s.health<=35) ? {t:"å¥åº·åä½", d:"å»ºè®®ä¼‘æ¯/é™ä½å¼ºåº¦"} : null;

      const world = (s.world && s.world.active) ? `
        <div class="card sec" data-act="openWorld">
          <div class="head">
            <h2>ä¸–ç•Œäº‹ä»¶</h2>
            <div class="hint">æŒç»­ä¸­</div>
          </div>
          <div class="pad" style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div>
              <b style="font-weight:950;font-size:13px">ğŸŒ ${s.world.title}ï¼ˆå‰©ä½™ ${s.world.remaining} å‘¨ï¼‰</b>
              <div class="subline" style="margin-top:6px">${s.world.meta}</div>
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end">
              ${s.world.tags.map(x=>`<span class="chip" style="cursor:default"><b class="${x.k==='good'?'good':x.k==='bad'?'bad':''}">${x.t}</b></span>`).join("")}
            </div>
          </div>
        </div>
      ` : "";

      const quickNav = [
        {id:"shops", e:"ğŸª", n:"åº—é“º", t:"è¯„åˆ†/åˆ©æ¶¦", red:true},
        {id:"staff", e:"ğŸ‘¥", n:"å‘˜å·¥", t:"ç¦»èŒé£é™©", red:true},
        {id:"delivery", e:"ğŸ›µ", n:"å¤–å–", t:"é¢„ç®—/æŠ½æˆ"},
        {id:"location", e:"ğŸ—ºï¸", n:"é€‰å€", t:"é—¨é¢åˆ·æ–°"},
        {id:"world", e:"ğŸŒ", n:"ä¸–ç•Œäº‹ä»¶", t:(s.world?.active?"æŒç»­ä¸­":"æ— ")},
        {id:"ach", e:"ğŸ†", n:"æˆå°±", t:"å¯é¢†å–", red:true},
        {id:"rank", e:"ğŸ“ˆ", n:"æ’è¡Œæ¦œ", t:"è´¢å¯Œæ¦œ"},
        {id:"welfare", e:"ğŸ", n:"ç¦åˆ©", t:"æ¯æ—¥å¥–åŠ±"},
      ];

      return `
        <div class="top">
          <div class="left">
            <div class="avatar"></div>
            <div class="title">
              <b>${s.playerName}</b>
              <span>ç§°å·ï¼š${s.title}</span>
            </div>
          </div>
          <div class="pill" data-act="openTimeline"><b>ç¬¬ ${s.week} å‘¨</b><span style="color:var(--muted)">Â· ç¬¬ ${s.year} å¹´ Â· ${season.icon} ${season.name}</span></div>
          <div style="display:flex; gap:8px">
            <div class="icon" data-act="help">â“</div>
            <div class="icon" data-act="save">ğŸ’¾</div>
            <div class="icon" data-act="settings">âš™ï¸</div>
          </div>
        </div>

        ${alert ? `
          <div class="card sec" style="border-color:rgba(255,176,32,.35); background:linear-gradient(180deg, rgba(255,176,32,.16), rgba(18,26,43,.35));" data-act="hideAlert">
            <div class="pad">
              <b style="font-weight:950; font-size:13px">${alert.t}</b>
              <div class="subline">${alert.d} <span style="float:right; font-family:var(--mono); opacity:.9">ç‚¹å‡»éšè—</span></div>
            </div>
          </div>
        ` : ""}

        <div class="card sec">
          <div class="hero">
            <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px">
              <div>
                <div style="font-size:12px; color:var(--muted)">ç°é‡‘</div>
                <div class="cash mono">${fmtMoney(s.cash)}</div>
                <div class="subline">æ€»èµ„äº§ï¼š${fmtMoney(s.assets)} Â· å¹´é¾„ ${s.age} Â· å£°æœ› ${s.rep}/100</div>
              </div>
              <div class="pill" data-act="openPlayer">ç©å®¶è¯¦æƒ…</div>
            </div>

            <div class="chips">
              <div class="chip" data-act="openNet">
                <span style="opacity:.9">å‡€ç°é‡‘æµ</span>
                <b class="${netClass} mono">${(net>=0?"+ ":"- ")+fmtMoney(Math.abs(net)).replace("Â¥ ","Â¥ ")}</b>
              </div>
              <div class="chip" data-act="openStatus">
                <span style="opacity:.9">å‹åŠ›</span>
                <b class="warn mono">${s.stress}/100</b>
              </div>
              <div class="chip" data-act="openStatus">
                <span style="opacity:.9">å¥åº·</span>
                <b class="${s.health<=35?'bad':(s.health<=60?'warn':'good')} mono">${s.health}/100</b>
              </div>
            </div>
          </div>
        </div>

        ${world}

        <div class="card sec">
          <div class="head"><h2>å¿«æ·å…¥å£</h2><div class="hint">ç‚¹è¿›å»æœ‰å†…å®¹é¡µ</div></div>
          <div class="grid">
            ${quickNav.map(x=>`
              <div class="nav" data-act="nav" data-to="${x.id}">
                ${x.red?'<div class="dot"></div>':''}
                <div class="e">${x.e}</div>
                <div class="n">${x.n}</div>
                <div class="t">${x.t}</div>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="card sec">
          <div class="head"><h2>åº—é“ºå¿«è§ˆ</h2><div class="hint">ç‚¹å‡»è¿›å…¥è¯¦æƒ…</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${s.shops.slice(0,3).map(sp=>{
              const p = sp.lastProfit ?? sp.baseProfit;
              return `
                <div class="row" data-act="openShop" data-id="${sp.id}">
                  <div style="min-width:0">
                    <b style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${sp.name}</b>
                    <span>â˜… ${sp.rating.toFixed(1)} Â· å ‚é£Ÿ/å¤–å– ${(sp.dineIn*100).toFixed(0)}% / ${(sp.delivery*100).toFixed(0)}%</span>
                  </div>
                  <div class="mono ${p>=0?'good':'bad'}" style="font-weight:950">
                    ${(p>=0?"+ ":"- ")+fmtMoney(Math.abs(p)).replace("Â¥ ","Â¥ ")}
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `;
    }

    // ===== Generic Page Shell =====
    function pageShell(title, subtitle, body){
      const season = seasonOfWeek(state.week);
      const back = `<div class="icon" data-act="back">â†</div>`;
      const right = `<div class="pill" data-act="openTimeline"><b>ç¬¬ ${state.week} å‘¨</b><span style="color:var(--muted)">Â· ${season.icon} ${season.name}</span></div>`;
      return `
        <div class="top">
          <div class="left">
            ${back}
            <div class="title">
              <b>${title}</b>
              <span>${subtitle||""}</span>
            </div>
          </div>
          ${right}
          <div style="display:flex; gap:8px">
            <div class="icon" data-act="home">ğŸ </div>
          </div>
        </div>
        ${body}
      `;
    }

    // ===== Pages =====
    function renderShops(){
      const body = `
        <div class="card sec">
          <div class="head"><h2>ä½ çš„åº—é“º</h2><div class="hint">${state.shops.length} å®¶</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${state.shops.map(sp=>{
              const p = sp.lastProfit ?? sp.baseProfit;
              return `
                <div class="row" data-act="openShop" data-id="${sp.id}">
                  <div style="min-width:0">
                    <b style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${sp.name}</b>
                    <span>â˜… ${sp.rating.toFixed(1)} Â· æœ¬å‘¨åˆ©æ¶¦é¢„ä¼°</span>
                  </div>
                  <div class="mono ${p>=0?'good':'bad'}" style="font-weight:950">
                    ${(p>=0?"+ ":"- ")+fmtMoney(Math.abs(p)).replace("Â¥ ","Â¥ ")}
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>

        <div class="card sec">
          <div class="head"><h2>å¸¸ç”¨æ“ä½œï¼ˆDemoï¼‰</h2><div class="hint">å ä½</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <button class="btn secondary" data-act="toast" data-msg="å¼€æ–°åº—æµç¨‹ï¼ˆDemoï¼‰">å¼€æ–°åº—</button>
            <button class="btn secondary" data-act="toast" data-msg="ç»­çº¦/è£…ä¿®ï¼ˆDemoï¼‰">ç»­çº¦ / è£…ä¿®</button>
          </div>
        </div>
      `;
      return pageShell("åº—é“º", "ç»è¥æ¦‚è§ˆä¸è¯¦æƒ…", body);
    }

    function renderShopDetail(id){
      const sp = state.shops.find(x=>x.id===id);
      if(!sp) return pageShell("åº—é“º", "æœªæ‰¾åˆ°", `<div class="card sec"><div class="pad">æœªæ‰¾åˆ°è¯¥åº—é“ºã€‚</div></div>`);
      const p = sp.lastProfit ?? sp.baseProfit;
      const dine = Math.round(p * sp.dineIn);
      const delv = Math.round(p * sp.delivery);
      const body = `
        <div class="card sec">
          <div class="head"><h2>${sp.name}</h2><div class="hint">è¯¦æƒ…é¡µï¼ˆDemoï¼‰</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <div class="row"><div><b>è¯„åˆ†</b><span>å½±å“æ‹›è˜/å®¢æµï¼ˆå ä½ï¼‰</span></div><div class="mono" style="font-weight:950">â˜… ${sp.rating.toFixed(1)}</div></div>
            <div class="row"><div><b>æœ¬å‘¨åˆ©æ¶¦</b><span>å«ä¸–ç•Œäº‹ä»¶å€ç‡ï¼ˆè‹¥æœ‰ï¼‰</span></div><div class="mono ${p>=0?'good':'bad'}" style="font-weight:950">${(p>=0?"+ ":"- ")+fmtMoney(Math.abs(p)).replace("Â¥ ","Â¥ ")}</div></div>
            <div class="row"><div><b>å ‚é£Ÿ/å¤–å–å æ¯”</b><span>${(sp.dineIn*100).toFixed(0)}% / ${(sp.delivery*100).toFixed(0)}%</span></div><div class="mono" style="font-weight:950">â€”</div></div>
          </div>
        </div>

        <div class="card sec">
          <div class="head"><h2>ç»è¥å°ç»“ï¼ˆç®€åŒ–ï¼‰</h2><div class="hint">å ä½</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <div class="row"><div><b>å ‚é£Ÿè´¡çŒ®</b><span>æŒ‰å æ¯”ä¼°ç®—</span></div><div class="mono">${fmtMoney(dine)}</div></div>
            <div class="row"><div><b>å¤–å–è´¡çŒ®</b><span>æŒ‰å æ¯”ä¼°ç®—</span></div><div class="mono">${fmtMoney(delv)}</div></div>
            <button class="btn secondary" data-act="toast" data-msg="å‡çº§è®¾å¤‡ï¼ˆDemoï¼‰">å‡çº§è®¾å¤‡</button>
            <button class="btn secondary" data-act="toast" data-msg="è°ƒæ•´èœå•ï¼ˆDemoï¼‰">è°ƒæ•´èœå•</button>
          </div>
        </div>
      `;
      return pageShell("åº—é“ºè¯¦æƒ…", "è¿”å›å¯ç»§ç»­æ¨è¿›å‘¨æ•°", body);
    }

    function renderStaff(){
      const body = `
        <div class="card sec">
          <div class="head"><h2>å‘˜å·¥åˆ—è¡¨</h2><div class="hint">${state.employees.length} äºº</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${state.employees.map(p=>`
              <div class="row" data-act="openEmp" data-id="${p.id}">
                <div>
                  <b>${p.name} Â· ${p.role}</b>
                  <span>çŠ¶æ€ï¼š${p.mood} Â· é£é™©ï¼š${p.risk}</span>
                </div>
                <div class="mono" style="font-weight:950">${fmtMoney(p.wage).replace("Â¥ ","Â¥ ")}/æœˆ</div>
              </div>
            `).join("")}
          </div>
        </div>
        <div class="card sec">
          <div class="head"><h2>ç®¡ç†æ“ä½œï¼ˆDemoï¼‰</h2><div class="hint">å ä½</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <button class="btn secondary" data-act="toast" data-msg="æ‹›è˜æµç¨‹ï¼ˆDemoï¼‰">æ‹›è˜</button>
            <button class="btn secondary" data-act="toast" data-msg="åŠ è–ª/æ’ç­ï¼ˆDemoï¼‰">åŠ è–ª / æ’ç­</button>
          </div>
        </div>
      `;
      return pageShell("å‘˜å·¥", "ç¦»èŒé£é™©ä¸å·¥èµ„", body);
    }

    function renderEmpDetail(id){
      const p = state.employees.find(x=>x.id===id);
      if(!p) return pageShell("å‘˜å·¥", "æœªæ‰¾åˆ°", `<div class="card sec"><div class="pad">æœªæ‰¾åˆ°è¯¥å‘˜å·¥ã€‚</div></div>`);
      const body = `
        <div class="card sec">
          <div class="head"><h2>${p.name}</h2><div class="hint">${p.role}</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <div class="row"><div><b>å¿ƒæƒ…</b><span>å½±å“æ•ˆç‡/ç¦»èŒï¼ˆå ä½ï¼‰</span></div><div class="mono">${p.mood}</div></div>
            <div class="row"><div><b>å·¥èµ„</b><span>æ¯å‘¨ç»“ç®—æŠ˜ç®—ï¼ˆå ä½ï¼‰</span></div><div class="mono">${fmtMoney(p.wage).replace("Â¥ ","Â¥ ")}/æœˆ</div></div>
            <div class="row"><div><b>é£é™©</b><span>è§¦å‘äº‹ä»¶å¯èƒ½æ€§ï¼ˆå ä½ï¼‰</span></div><div class="mono ${p.risk!=='â€”'?'warn':''}">${p.risk}</div></div>
            <button class="btn secondary" data-act="toast" data-msg="è°ˆè¯/å®‰æŠšï¼ˆDemoï¼‰">è°ˆè¯/å®‰æŠš</button>
            <button class="btn secondary" data-act="toast" data-msg="è°ƒæ•´æ’ç­ï¼ˆDemoï¼‰">è°ƒæ•´æ’ç­</button>
          </div>
        </div>
      `;
      return pageShell("å‘˜å·¥è¯¦æƒ…", "å¤„ç†é£é™©ä¸æ•ˆç‡", body);
    }

    function renderDelivery(){
      const d = state.delivery;
      const body = `
        <div class="card sec">
          <div class="head"><h2>å¤–å–æ¦‚è§ˆ</h2><div class="hint">æ¸ é“ç®¡ç†</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <div class="row"><div><b>æ˜¯å¦å¼€é€š</b><span>å½±å“è®¢å•ç»“æ„</span></div><div class="mono ${d.enabled?'good':'bad'}" style="font-weight:950">${d.enabled?'å·²å¼€é€š':'æœªå¼€é€š'}</div></div>
            <div class="row"><div><b>å¹³å°æŠ½æˆ</b><span>ï¼ˆDemo å›ºå®šï¼‰</span></div><div class="mono">${Math.round(d.feeRate*100)}%</div></div>
            <div class="row"><div><b>æ¨å¹¿é¢„ç®—</b><span>ï¼ˆDemo å¯è°ƒï¼‰</span></div><div class="mono">${fmtMoney(d.budget).replace("Â¥ ","Â¥ ")}</div></div>
            <div class="row"><div><b>æœ¬å‘¨è®¢å•</b><span>ï¼ˆDemo å›ºå®šï¼‰</span></div><div class="mono">${d.orders}</div></div>

            <button class="btn secondary" data-act="toggleDelivery">${d.enabled?'æš‚åœå¤–å–':'å¼€é€šå¤–å–'}</button>
            <button class="btn secondary" data-act="adjustBudget">è°ƒæ•´æ¨å¹¿é¢„ç®—</button>
          </div>
        </div>
      `;
      return pageShell("å¤–å–", "é¢„ç®—ä¸æŠ½æˆ", body);
    }

    function renderLocation(){
      const body = `
        <div class="card sec">
          <div class="head"><h2>å¯é€‰é—¨é¢</h2><div class="hint">åˆ·æ–°ï¼ˆDemoï¼‰</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${state.locations.map(l=>`
              <div class="row" data-act="openLoc" data-id="${l.id}">
                <div>
                  <b>${l.name}</b>
                  <span>äººæµï¼š${l.foot} Â· ç«äº‰ï¼š${l.competition}</span>
                </div>
                <div class="mono" style="font-weight:950">${fmtMoney(l.rent).replace("Â¥ ","Â¥ ")}/æœˆ</div>
              </div>
            `).join("")}
          </div>
        </div>
        <div class="card sec">
          <div class="head"><h2>æç¤º</h2><div class="hint">å ä½</div></div>
          <div class="pad">
            <div style="color:var(--muted); font-size:12px; line-height:1.5">
              çœŸå®ç‰ˆæœ¬å»ºè®®å±•ç¤ºï¼šæŠ¼é‡‘ã€é¢„è®¡å®¢æµã€åŒç±»ç«äº‰ã€ç›®æ ‡å®¢ç¾¤åŒ¹é…åº¦ç­‰ï¼Œå¹¶åœ¨â€œå¼€åº—/æ¬åº—â€æ—¶åšèµ„é‡‘æ ¡éªŒä¸äº‹ä»¶è§¦å‘ã€‚
            </div>
          </div>
        </div>
      `;
      return pageShell("é€‰å€/é—¨é¢", "é€‰åº—å€ä¸ç§Ÿé‡‘", body);
    }

    function renderLocDetail(id){
      const l = state.locations.find(x=>x.id===id);
      if(!l) return pageShell("é—¨é¢è¯¦æƒ…", "æœªæ‰¾åˆ°", `<div class="card sec"><div class="pad">æœªæ‰¾åˆ°é—¨é¢ã€‚</div></div>`);
      const body = `
        <div class="card sec">
          <div class="head"><h2>${l.name}</h2><div class="hint">è¯¦æƒ…é¡µï¼ˆDemoï¼‰</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <div class="row"><div><b>ç§Ÿé‡‘</b><span>æ¯å‘¨æ‘Šé”€ï¼ˆå ä½ï¼‰</span></div><div class="mono">${fmtMoney(l.rent).replace("Â¥ ","Â¥ ")}/æœˆ</div></div>
            <div class="row"><div><b>äººæµ</b><span>å½±å“å ‚é£Ÿ</span></div><div class="mono">${l.foot}</div></div>
            <div class="row"><div><b>ç«äº‰</b><span>å½±å“å®¢æµä¸è¯„åˆ†</span></div><div class="mono">${l.competition}</div></div>
            <button class="btn secondary" data-act="toast" data-msg="ç­¾çº¦/æ¬åº—ï¼ˆDemoï¼‰">ç­¾çº¦/æ¬åº—</button>
          </div>
        </div>
      `;
      return pageShell("é—¨é¢è¯¦æƒ…", "è¯„ä¼°æˆæœ¬ä¸æœºä¼š", body);
    }

    function renderWorld(){
      const w = state.world;
      const body = `
        <div class="card sec">
          <div class="head"><h2>å½“å‰ä¸–ç•Œäº‹ä»¶</h2><div class="hint">${w.active?'æ¿€æ´»ä¸­':'æ— '}</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${w.active ? `
              <div class="row"><div><b>${w.title}</b><span>${w.meta}</span></div><div class="mono warn">å‰©ä½™ ${w.remaining} å‘¨</div></div>
              <div class="row"><div><b>ä¸»è¦å½±å“</b><span>å€ç‡å åŠ ï¼ˆDemoï¼‰</span></div><div class="mono">${w.tags.map(x=>x.t).join(" / ")}</div></div>
              <button class="btn secondary" data-act="toast" data-msg="æŸ¥çœ‹è§„åˆ™ç»†èŠ‚ï¼ˆDemoï¼‰">æŸ¥çœ‹è§„åˆ™ç»†èŠ‚</button>
            ` : `
              <div style="color:var(--muted); font-size:12px; line-height:1.5">
                æš‚æ— æ¿€æ´»çš„ä¸–ç•Œäº‹ä»¶ã€‚çœŸå®ç‰ˆæœ¬å¯å±•ç¤ºï¼šäº‹ä»¶æ± ã€è§¦å‘æ¡ä»¶ã€æŒç»­å‘¨æ•°ã€å åŠ /äº’æ–¥è§„åˆ™ã€‚
              </div>
            `}
          </div>
        </div>
      `;
      return pageShell("ä¸–ç•Œäº‹ä»¶", "ä¸å ç”¨æ¯å‘¨äº¤äº’äº‹ä»¶åé¢", body);
    }

    function renderAchievements(){
      const body = `
        <div class="card sec">
          <div class="head"><h2>æˆå°±</h2><div class="hint">é¢†å–å¥–åŠ±ï¼ˆDemoï¼‰</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${state.achievements.map(a=>{
              const pct = Math.round(a.prog*100);
              return `
                <div class="row">
                  <div style="min-width:0">
                    <b>${a.name}</b>
                    <span>${a.desc} Â· ${pct}%</span>
                  </div>
                  <div>
                    ${a.claim ? `<span class="pill" style="font-weight:950" data-act="claim" data-id="${a.id}">é¢†å–</span>` : `<span class="mono">${pct}%</span>`}
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `;
      return pageShell("æˆå°±", "è¿›åº¦ä¸é¢†å–", body);
    }

    function renderRank(){
      const body = `
        <div class="card sec">
          <div class="head"><h2>æ’è¡Œæ¦œ</h2><div class="hint">è´¢å¯Œæ¦œï¼ˆDemoï¼‰</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${state.leaderboard.map(x=>`
              <div class="row">
                <div><b>#${x.rank} ${x.name}</b><span>ç°é‡‘</span></div>
                <div class="mono" style="font-weight:950">${fmtMoney(x.cash)}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
      return pageShell("æ’è¡Œæ¦œ", "çœ‹çœ‹ä½ çš„ä½ç½®", body);
    }

    function renderWelfare(){
      const w = state.welfare;
      const body = `
        <div class="card sec">
          <div class="head"><h2>ç¦åˆ©</h2><div class="hint">æ¯æ—¥å¥–åŠ±ï¼ˆDemoï¼‰</div></div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            <div class="row"><div><b>æ¯æ—¥ç™»å½•å¥–åŠ±</b><span>ç°é‡‘ +Â¥1,000</span></div><div class="mono">${w.dailyClaimed?"å·²é¢†å–":"æœªé¢†å–"}</div></div>
            <button class="btn ${w.dailyClaimed?'secondary':''}" data-act="claimDaily" ${w.dailyClaimed?'disabled':''}>${w.dailyClaimed?'ä»Šæ—¥å·²é¢†å–':'é¢†å–ä»Šæ—¥å¥–åŠ±'}</button>
            <div class="row"><div><b>è·³è¿‡åˆ¸</b><span>ç”¨äºè·³è¿‡åŠ¨ç”»/äº‹ä»¶ï¼ˆå ä½ï¼‰</span></div><div class="mono">${w.skipTickets} å¼ </div></div>
            <button class="btn secondary" data-act="toast" data-msg="è§‚çœ‹å¹¿å‘Šè·å¾—å¥–åŠ±ï¼ˆDemoï¼‰">çœ‹å¹¿å‘Šé¢†å¥–åŠ±</button>
          </div>
        </div>
      `;
      return pageShell("ç¦åˆ©", "è½»é‡å˜ç°å…¥å£å ä½", body);
    }

    // ===== Event (ç®€ç‰ˆï¼šé€‰æ‹©åç«‹åˆ»ç»“ç®—å¹¶å› Home) =====
    function renderEvent(ev){
      const season = seasonOfWeek(state.week);
      const body = `
        <div class="card sec">
          <div class="head"><h2>ç¬¬ ${state.week} å‘¨äº‹ä»¶</h2><div class="hint">${season.icon} ${season.name}</div></div>
          <div class="pad" style="color:rgba(232,238,252,.92); font-size:13px; line-height:1.55">
            <b style="font-weight:950; font-size:16px">${ev.title}</b>
            <div style="margin-top:8px; color:var(--muted)">${ev.body}</div>
          </div>
          <div class="pad" style="display:flex; flex-direction:column; gap:10px">
            ${ev.choices.map(ch=>{
              const e=ch.effects;
              const fx = [
                `<i class="${e.cashEvent>=0?'g':'b'}">${e.cashEvent>=0?'+':'-'}ç°é‡‘ ${fmtMoney(Math.abs(e.cashEvent)).replace('Â¥ ','Â¥ ')}</i>`,
                `<i class="${e.stress<=0?'g':'w'}">${e.stress>=0?'+':'-'}å‹åŠ› ${Math.abs(e.stress)}</i>`,
              ];
              if(e.health!==0) fx.push(`<i class="${e.health>=0?'g':'w'}">${e.health>=0?'+':'-'}å¥åº· ${Math.abs(e.health)}</i>`);
              if(e.rep!==0) fx.push(`<i class="${e.rep>=0?'g':'b'}">${e.rep>=0?'+':'-'}å£°æœ› ${Math.abs(e.rep)}</i>`);
              return `
                <div class="row choice" data-act="choose" data-cid="${ch.id}">
                  <div style="min-width:0">
                    <b>${ch.id}. ${ch.title}</b>
                    <span>${ch.desc}</span>
                    <div class="fx">${fx.join("")}</div>
                  </div>
                  <div class="mono" style="font-weight:950">â†’</div>
                </div>
              `;
            }).join("")}
          </div>
        </div>

        <div class="card sec">
          <div class="head"><h2>è¯´æ˜</h2><div class="hint">v2 ä¸ºçŸ­æ–‡ä»¶åšç®€åŒ–</div></div>
          <div class="pad" style="color:var(--muted); font-size:12px; line-height:1.55">
            v2 æŠŠâ€œç»“ç®—åŠ¨ç”»â€ç®€åŒ–ä¸ºï¼šé€‰æ‹©åç«‹åˆ»ç»“ç®—å¹¶å›åˆ°ä¸»ç”»é¢ï¼ˆä½†ä»æ›´æ–°ï¼šå‘¨æ•°ã€ç°é‡‘ã€çŠ¶æ€ã€æ—¶é—´çº¿ã€ä¸–ç•Œäº‹ä»¶å‰©ä½™å‘¨æ•°ï¼‰ã€‚
          </div>
          <div class="pad"><button class="btn secondary" data-act="back">è¿”å›ä¸»ç”»é¢</button></div>
        </div>
      `;
      return pageShell("æœ¬å‘¨äº‹ä»¶", "é€‰æ‹©ä¸€é¡¹æ¨è¿› 1 å‘¨", body);
    }

    function settle(ev, ch){
      // Shop profit with world multiplier
      let shopProfit = 0;
      state.shops.forEach(sp=>{
        const base = sp.baseProfit;
        const dine = base * sp.dineIn;
        const delv = base * sp.delivery;
        const dineAdj = state.world?.active ? dine * state.world.dineInMul : dine;
        const delvAdj = state.world?.active ? delv * state.world.deliveryMul : delv;
        const fixed = state.world?.active ? -180 : 0;
        const p = Math.round(dineAdj + delvAdj + fixed);
        sp.lastProfit = p;
        shopProfit += p;
      });

      const eventCash = ch.effects.cashEvent;
      const net = Math.round(shopProfit - state.livingCost - state.loanPay + eventCash);
      state._lastNet = net;

      // Apply state changes
      state.cash = Math.round(state.cash + net);
      state.assets = Math.round(state.assets + net * 0.35);
      state.stress = clamp(Math.round(state.stress + ch.effects.stress), 0, 100);
      state.health = clamp(Math.round(state.health + ch.effects.health), 0, 100);
      state.rep = clamp(Math.round(state.rep + ch.effects.rep), 0, 100);

      if(state.stress >= 90) state.stressMaxWeeks = Math.min(4, state.stressMaxWeeks + 1);
      else state.stressMaxWeeks = Math.max(0, state.stressMaxWeeks - 1);

      // time
      state.week += 1;
      if(state.week % 52 === 1 && state.week !== 1) state.year += 1;
      if(state.week % 52 === 1) state.age += 1;

      // world event remaining
      if(state.world?.active){
        state.world.remaining -= 1;
        if(state.world.remaining <= 0) state.world.active = false;
      }

      // timeline
      state.timeline.push({ week: state.week - 1, title: `${ev.title}ï¼ˆé€‰ ${ch.id}ï¼‰`, net });

      toast(`å·²ç»“ç®—ï¼šå‡€ç°é‡‘æµ ${(net>=0?'+':'-')}${fmtMoney(Math.abs(net)).replace('Â¥ ','Â¥ ')}`);
    }

    // ===== Render dispatcher =====
    function render(){
      $("#footer").style.display = (router.view==="home") ? "flex" : "none";

      let html = "";
      if(router.view==="home") html = renderHome();
      else if(router.view==="shops") html = renderShops();
      else if(router.view==="shop") html = renderShopDetail(router.params.id);
      else if(router.view==="staff") html = renderStaff();
      else if(router.view==="emp") html = renderEmpDetail(router.params.id);
      else if(router.view==="delivery") html = renderDelivery();
      else if(router.view==="location") html = renderLocation();
      else if(router.view==="loc") html = renderLocDetail(router.params.id);
      else if(router.view==="world") html = renderWorld();
      else if(router.view==="ach") html = renderAchievements();
      else if(router.view==="rank") html = renderRank();
      else if(router.view==="welfare") html = renderWelfare();
      else if(router.view==="event") html = renderEvent(router.params.ev);
      else html = renderHome();

      app.innerHTML = html;
    }

    // ===== Actions (event delegation) =====
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-act]');
      if(!el) return;
      const act = el.getAttribute('data-act');

      if(act==="home" || act==="back"){ setView("home"); return; }
      if(act==="toast"){ toast(el.getAttribute('data-msg')||"Demo"); return; }
      if(act==="help"){ toast("å¸®åŠ©ï¼ˆDemoï¼‰"); return; }
      if(act==="save"){ toast("å­˜æ¡£/è¯»æ¡£ï¼ˆDemoï¼‰"); return; }
      if(act==="settings"){ toast("è®¾ç½®ï¼ˆDemoï¼‰"); return; }

      if(act==="openTimeline"){
        const items = state.timeline.slice(-10).reverse().map(it=>{
          const t = (it.net>=0?"+ ":"- ") + fmtMoney(Math.abs(it.net)).replace("Â¥ ","Â¥ ");
          return `<div class="row"><div><b>ç¬¬ ${it.week} å‘¨</b><span>${it.title}</span></div><div class="mono ${it.net>=0?'good':'bad'}" style="font-weight:950">${t}</div></div>`;
        }).join("") || `<div class="row"><span>æš‚æ— è®°å½•</span><b class="mono">â€”</b></div>`;
        openSheet("æ—¶é—´çº¿ï¼ˆæœ€è¿‘ 10 å‘¨ï¼‰", items);
        return;
      }

      if(act==="openNet"){
        const lastNet = state._lastNet ?? 6820;
        const shopProfit = state.shops.reduce((a,x)=>a+(x.lastProfit ?? x.baseProfit),0);
        openSheet("æœ¬å‘¨å‡€ç°é‡‘æµæ„æˆ", `
          <div class="row"><span>åº—é“ºåˆ©æ¶¦æ±‡æ€»</span><b class="mono">${fmtMoney(shopProfit)}</b></div>
          <div class="row"><span>ç”Ÿæ´»/å®¶åº­æ”¯å‡º</span><b class="mono bad">- ${fmtMoney(state.livingCost).replace("Â¥ ","Â¥ ")}</b></div>
          <div class="row"><span>è´·æ¬¾è¿˜æ¬¾</span><b class="mono bad">- ${fmtMoney(state.loanPay).replace("Â¥ ","Â¥ ")}</b></div>
          <div class="row"><span><b>åˆè®¡</b></span><b class="mono ${lastNet>=0?'good':'bad'}">${(lastNet>=0?"+ ":"- ")+fmtMoney(Math.abs(lastNet)).replace("Â¥ ","Â¥ ")}</b></div>
        `);
        return;
      }

      if(act==="openStatus"){
        openSheet("çŠ¶æ€è¯¦æƒ…ï¼ˆå ä½ï¼‰", `
          <div class="row"><span>å‹åŠ›</span><b class="mono warn">${state.stress}/100</b></div>
          <div class="row"><span>å¥åº·</span><b class="mono ${state.health<=35?'bad':(state.health<=60?'warn':'good')}">${state.health}/100</b></div>
          <div class="row"><span>å£°æœ›</span><b class="mono">${state.rep}/100</b></div>
          <div style="color:var(--muted); font-size:12px; line-height:1.5">
            çœŸå®ç‰ˆæœ¬ï¼šè¿™é‡Œå¯å±•ç¤ºâ€œæ»¡å€¼æŒç»­å‘¨æ•°ã€ç–¾ç—…é£é™©ã€å£°æœ›å¸¦æ¥çš„é¢åº¦/æ‹›è˜åŠ æˆâ€ç­‰ã€‚
          </div>
        `);
        return;
      }

      if(act==="openPlayer"){
        openSheet("ç©å®¶è¯¦æƒ…ï¼ˆå ä½ï¼‰", `
          <div class="row"><span>ç©å®¶</span><b>${state.playerName}</b></div>
          <div class="row"><span>ç§°å·</span><b>${state.title}</b></div>
          <div class="row"><span>å¹´é¾„</span><b class="mono">${state.age}</b></div>
          <div class="row"><span>ç°é‡‘</span><b class="mono">${fmtMoney(state.cash)}</b></div>
          <div class="row"><span>æ€»èµ„äº§</span><b class="mono">${fmtMoney(state.assets)}</b></div>
        `);
        return;
      }

      if(act==="hideAlert"){ toast("å·²éšè—æç¤ºï¼ˆDemoï¼‰"); return; }

      if(act==="nav"){
        const to = el.getAttribute('data-to');
        const map = {shops:"shops", staff:"staff", delivery:"delivery", location:"location", world:"world", ach:"ach", rank:"rank", welfare:"welfare"};
        setView(map[to] || "home");
        return;
      }
      if(act==="openShop"){ setView("shop", {id: el.getAttribute('data-id')}); return; }
      if(act==="openEmp"){ setView("emp", {id: el.getAttribute('data-id')}); return; }
      if(act==="toggleDelivery"){ state.delivery.enabled = !state.delivery.enabled; toast(state.delivery.enabled ? "å·²å¼€é€šå¤–å–" : "å·²æš‚åœå¤–å–"); setView("delivery"); return; }
      if(act==="adjustBudget"){
        openSheet("è°ƒæ•´æ¨å¹¿é¢„ç®—ï¼ˆDemoï¼‰",
          `<div class="row"><span>å½“å‰é¢„ç®—</span><b class="mono">${fmtMoney(state.delivery.budget).replace("Â¥ ","Â¥ ")}</b></div>
           <button class="btn secondary" data-act="budget" data-d="50">+50</button>
           <button class="btn secondary" data-act="budget" data-d="-50">-50</button>
           <div style="color:var(--muted); font-size:12px; line-height:1.5">è¿™é‡Œå¯ä»¥æ¢æˆ sliderï¼Œå¹¶å½±å“è®¢å•/åˆ©æ¶¦æ¨¡å‹ã€‚</div>`
        );
        return;
      }
      if(act==="budget"){
        const d = parseInt(el.getAttribute('data-d'),10) || 0;
        state.delivery.budget = clamp(state.delivery.budget + d, 0, 2000);
        toast("é¢„ç®—ï¼š" + fmtMoney(state.delivery.budget).replace("Â¥ ","Â¥ "));
        closeSheet();
        setView("delivery");
        return;
      }
      if(act==="openLoc"){ setView("loc", {id: el.getAttribute('data-id')}); return; }
      if(act==="claim"){
        const id = el.getAttribute('data-id');
        const a = state.achievements.find(x=>x.id===id);
        if(a && a.claim){ a.claim=false; toast("å·²é¢†å–å¥–åŠ±ï¼ˆDemoï¼‰"); setView("ach"); }
        return;
      }
      if(act==="claimDaily"){
        if(state.welfare.dailyClaimed) return;
        state.welfare.dailyClaimed = true;
        state.cash += 1000;
        toast("é¢†å–æˆåŠŸï¼šç°é‡‘ +Â¥1,000");
        setView("welfare");
        return;
      }
      if(act==="openWorld"){ setView("world"); return; }

      if(act==="choose"){
        const ev = router.params.ev;
        const cid = el.getAttribute('data-cid');
        const ch = ev.choices.find(x=>x.id===cid);
        settle(ev, ch);
        setView("home");
        return;
      }
    });

    // Footer buttons
    $("#btnTimeline").addEventListener('click', ()=>openSheet("æ—¶é—´çº¿ï¼ˆæœ€è¿‘ 10 å‘¨ï¼‰",
      state.timeline.slice(-10).reverse().map(it=>{
        const t = (it.net>=0?"+ ":"- ") + fmtMoney(Math.abs(it.net)).replace("Â¥ ","Â¥ ");
        return `<div class="row"><div><b>ç¬¬ ${it.week} å‘¨</b><span>${it.title}</span></div><div class="mono ${it.net>=0?'good':'bad'}" style="font-weight:950">${t}</div></div>`;
      }).join("") || `<div class="row"><span>æš‚æ— è®°å½•</span><b class="mono">â€”</b></div>`
    ));
    $("#btnStart").addEventListener('click', ()=>{
      const ev = eventsPool[Math.floor(Math.random()*eventsPool.length)];
      setView("event", {ev});
    });

    // Init
    render();
  </script>
</body>
</html>
